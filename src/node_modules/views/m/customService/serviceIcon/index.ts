import * as tomato from "@po-to/tomato";
import * as tdom from "@po-to/tomato-jquery";
import * as project from "views/global/common/Project";
import * as funs from "views/global/common/Funs";
import * as model from "views/global/common/Model";
import * as api from "views/global/common/API";
import * as track from "views/global/common/Track";

class VPresenter extends project.VPresenter {
    private _call_phone: JQuery;
    private _chat_SS: JQuery;
    private _service_pane: JQuery;
    private _word: JQuery;
    private _close: JQuery;
    constructor(view: tomato.VPView, parent?: tomato.VPresenter, vpid?: string) {
        super(view, parent, vpid);
        this._watchEvent();
        //this._els = this._getElements();

        this._call_phone = this.find(".call_phone");
        this._chat_SS = this.find(".chat_SS");
        this._service_pane = this.find(".service_pane");
        this._word = this.find(".service_pane_show_word");
        this._close = this.find(".close_button");
        let that = this;

        var keywords = window['wd'];
        if (keywords) {
            this._word.text("在找“" + keywords + "”？");
            // im初始化之后，显示自动发送的消息
            $(document).on('imInit', function () {
                api.sendMsgWithKeyWords({ uid: model.globalData.user.user_id, msg: that._word.text() }, function (data) {
                    that._call_phone.addClass("call_bottom");
                    that._chat_SS.addClass("SS_visible");
                    that._service_pane.removeClass("SS_hidden");
                }, function (data) {
                    console.log(data);
                })
            });
        }

        /**新消息显示*/
        $(document).on('newMsgFromServ', function (e, text) {
            var unread = webimConfigs.getPool()['4'].unread;
            if (unread == 0) {
                that.find('.unread').hide().html('');
            } else {
                if (unread > 9) {
                    unread = '…'
                }
                that.find('.unread').show().html(unread);
            }
            that._word.text(text);
            that._call_phone.addClass("call_bottom");
            that._chat_SS.addClass("SS_visible");
            that._service_pane.removeClass("SS_hidden");
        });

        /**关掉回复 */
        this._close.on('click', () => {
            this._call_phone.removeClass("call_bottom");
            this._chat_SS.removeClass("SS_visible");
            this._service_pane.addClass("SS_hidden");
            // 更改reffer
            if (window['wd']) {
                var href = window.location.href;
                window.location.href = href + '#';
            }
        });
    }
    /**打开聊天界面 */
    private _evt_openServiceChatPane() {
        this._call_phone.removeClass("call_bottom");
        this._chat_SS.removeClass("SS_visible");
        this._service_pane.addClass("SS_hidden");
        tomato.getVPresenter<tomato.VPresenter>(funs.moduleToUrl('m/customService/serviceChatPane'), (serviceChatPane) => {
            //聊天界面
            // funs.loadPage(serviceChatPane);
            tdom.open(serviceChatPane,'_blank',{size:{width:"100%",height:"100%"}});
        });
        // 更改reffer
        if (window['wd']) {
            var href = window.location.href;
            window.location.href = href + '#';
        }
    };
    _evt_clearMsg(){
        this._call_phone.removeClass("call_bottom");
        this._chat_SS.removeClass("SS_visible");
        this._service_pane.addClass("SS_hidden");
    }
    _evt_repairConsult(){
        if (this.getPageUrl() == "Index") {
            track.setup_consult();
            return true;
        } else if (this.getPageUrl() == "Repair") {
            track.repair_consult();
            return true;
        }
    }
    _evt_repair400(){
        if (this.getPageUrl() == "Index") {
            track.setup_400();
            return true;
        } else if (this.getPageUrl() == "Repair") {
            track.repair_400();
            return true;
        }
    }
    private getPageUrl() {
        var pageUrls = window.location.href.indexOf('Repair');
        if(pageUrls > 0){
            return "Repair"
        }else{
            return "Index"
        }
    }
}
export = VPresenter;