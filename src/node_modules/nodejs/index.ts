var connect = require('connect');
var serveStatic = require("serve-static");

var staticSite = serveStatic('`{VIEWSDIST}`',{'index': 'index.html','fallthrough':false,'setHeaders': function(res, path){
    res.setHeader('Access-Control-Allow-Origin', '*')
}})

var staticSite2 = serveStatic('`{NODEJSDIST}`',{'index': 'index.html','fallthrough':false,'setHeaders': function(res, path){
    res.setHeader('Access-Control-Allow-Origin', '*')
}})

var server = connect()
    .use(function(req, res, next) {
        var host = req.headers.host;
        var sites = (`{SITES}` as any);
        var url,domain;
        for(domain in sites){
            var src = sites[domain];
            if(host.startsWith(domain)){
                url = src+req.url;
                break;
            }
        }
        if(url){
            // console.log(req.url,domain);
            if(domain=="`{VIEWSSITE}`" || req.url.startsWith('/track/')){
                req.url = url;
                staticSite(req, res, next)
            }else{
                req.url = url;
                staticSite2(req, res, next)
            }
        }else{
            next(new Error('not found!'));
        }
    })
    .use(function(err, req, res, next) {
        //console.log(err.status);
        if(err.message=="not found!"){
            res.writeHead(404);
        }else{
            res.writeHead(500);
        }
        res.end(`<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>访问出错了</title>
    <link rel="stylesheet" href="http://sview.wanpinghui.com/global/sass/bootstrap.css">
    <style>
    .error{
        text-align: center;
        padding-left:30px;
        padding-right: 30px;
        position: relative;
    }
    img{
        height:245px;
        width:60px;
        margin-bottom: 49px;
    }
    h5{
        font-weight: 700;
    }
    p{
        color:#7db4f4;
        font-size:12px;
        margin-bottom: 104px;
        position: relative;
    }
    #time{
        color:#0c5ef7;
        font-size: 14px;
        position: absolute;
        right: 44px;
        bottom: 12px;
        font-weight: 600;
    }
    #btn{
        width: 100%;
        height:44px;
        padding:11px 0;
    }
   @media (min-width: 767px){
       .error{
            text-align: center;
            position: relative;
        }
        img{
            height:311px;
            width:60px;
            margin-bottom: 119px;
        }
        h5{
            font-weight: 700;
            font-size: 20px;
        }
        p{
            color:#7db4f4;
            font-size:14px;
            margin-bottom: 151px;
            position: relative;
        }
        #time{
           color:#0c5ef7; 
           font-size: 14px;
           position: relative;
           left: 228px;
           bottom: -1px;
           font-weight: 600;
        }
        #btn{
            font-size:14px;
            width: 250px;
            height:50px;
            padding:16px 0;
        }
    }
    
    </style>
</head>

<body>
    <div class="error">
        <img src="http://sview.wanpinghui.com/global/error/images/Group2.png">
        <h5 class="text-center">啊哦～ 您访问的页面走丢了</h5>
        <p class="text-center">（404:参数错误）</p>
        <span id="time"> 5s</span>
        <a id="btn" href="/" class="btn btn-primary" type="button"> 返回首页</a>
    </div>
    <script language="JavaScript">
        // document.getElementById('btn').setAttribute("disabled","disabled");  //不可编辑状态
        var wait = 5;
        var waitTime = document.getElementById("time");
        var timer = setInterval(function () {
            wait--;
            waitTime.innerHTML = wait + 's';
            if (wait < 1) {
                clearInterval(timer);
                this.timer = null;
                waitTime.style.display = 'none';
                window.location.href = '/';
                // document.getElementById('btn').removeAttribute("disabled"); //可编辑状态
            }
        }, 1000)
    </script>
</body>

</html>`);
        
    // set locals, only providing error in development
    //res.locals.message = err.message;
    //res.locals.error = req.entrance.get('env') === 'development' ? err : {};

    // render the error page
    //res.status(err.status || 500);
        //
        
    })
    .listen(`{SITEPORT}`);

        